# Author: Knightsbr1dge
# Web: https://www.knightsbr1dge.red
# Social: "Knightrsbr1dge" on IG and Twitter

# This PowerShell script will set up a new training domain

#Set Params
Param(
    [String]$DomainName,
    [String]$Password
)

# Get the domain name from the user
Write-Warning "This script will build a domain for testing and lab purposes"
Write-Warning "DO NOT use this script to create a production domain" 
$DomainName = Read-Host "Please enter a valid domain name (e.g CONTOSO.LAB)"

# Check the domain name is valid
if (!$DomainName) {
    Write-Warning "No input detected. Exiting."
}
elseif ($DomainName -eq ".") {
    Write-Warning "Really? A dot? Oh dear."
}
elseif ($DomainName -like '*.*') {
    Write-Host "Domain name appears to be valid. Using $DomainName as the domain name." -f Green
}
else {
    Write-Warning "Domin appears to be invalid. Check your input and try again."
}

# Set the NetBIOS variable
$NetBIOS = Read-Host "Please enter a valid NetBIOS name (e.g CONTOSO)"

# Set the administrative password
$Password='Passw0rd1!'

# Add AD DS to the Server
Install-WindowsFeature AD-Domain-Services -IncludeManagementTools -IncludeAllSubFeature

# Set local admin password
net user Administrator $Password

# Install new forest
Import-Module ADDSDeployment
Write-Host "About to install the AD Forest."

Install-ADDSForest `
-SkipPreChecks `
-CreateDnsDelegation:$false `
-DatabasePath "C:\Windows\NTDS" `
-DomainMode "WinThreshold" `
-DomainName $DomainName `
-DomainNetbiosName $NetBIOS `
-ForestMode "WinThreshold" `
-InstallDns:$true `
-LogPath "C:\Windows\NTDS" `
-NoRebootOnCompletion:$True `
-SysvolPath "C:\Windows\SYSVOL" `
-SafeModeAdministratorPassword (ConvertTo-SecureString -String $Password -AsPlainText -Force) `
-Force:$true

# Reboot
$Reboot = Read-Host "Would you like to reboot now? Y/N"
if ($Reboot -like 'y') {
    Restart-Computer -force
}
elseif ($Reboot -like 'n') {
    Return
}
else {
    Write-Host "Invalid option select. Exiting now..."
    Return
}
